<!--
  ~ Copyright 2014-2016 European Environment Agency
  ~
  ~ Licensed under the EUPL, Version 1.1 or â€“ as soon
  ~ they will be approved by the European Commission -
  ~ subsequent versions of the EUPL (the "Licence");
  ~ You may not use this work except in compliance
  ~ with the Licence.
  ~ You may obtain a copy of the Licence at:
  ~
  ~ https://joinup.ec.europa.eu/community/eupl/og_page/eupl
  ~
  ~ Unless required by applicable law or agreed to in
  ~ writing, software distributed under the Licence is
  ~ distributed on an "AS IS" basis,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND,
  ~ either express or implied.
  ~ See the Licence for the specific language governing
  ~ permissions and limitations under the Licence.
  -->

<div class="row" data-ng-controller="HarvesterConfigCtrl">
  <div class="col-md-4">
    <br/>

    <div class="panel panel-default">
      <div class="panel-heading">
        <span data-translate="">harvester</span>
        <i data-ng-show="!harvesterConfig"
           class="fa fa-spinner fa-spin"></i>
      </div>
      <div class="panel-body">
        <input class="form-control"
               data-ng-model="harvesterSearch.$"
               placeholder="{{'filter'}}"/>

        <div class="list-group">
          <a class="list-group-item"
             data-ng-repeat="h in harvesterConfig | filter:harvesterSearch | orderBy:predicate:reverse"
             title="{{h.name}}"
             data-ng-href="#/harvesting/manage?uuid={{h.uuid}}">
            {{h.name | limitTo: 40}}{{h.name.length > 30 ? '...' : ''}}
            <span data-ng-if="statsForScope[h.uuid].count">
              ({{statsForScope[h.uuid].count}}
              <span data-translate="">records</span>)</span>
          </a>
        </div>

        <br/>

        <button class="btn btn-default"
                data-ng-if="getUser().authenticated"
                data-ng-click="startAdding()"
                title="{{'add' | translate}}">
          <i class="fa fa-plus"></i>
        </button>

        <p class="alert alert-info"
           data-translate=""
           data-translate-values="{pollingInterval: '{{pollingInterval}}'}">
          harvesterConfigPage</p>
      </div>
    </div>
  </div>
  <div class="col-md-8">
    <br/>

    <div class="panel panel-default" data-ng-show="selected">
      <div class="panel-heading">
        {{selected.name}}
        <small data-ng-show="statsForScope[selected.uuid]">
          <strong>
            {{statsForScope[selected.uuid].count}}
            <span data-translate="">records</span>
          </strong>
        </small>
        <small data-ng-show="statsForScope[selected.uuid].count && statsForRemote[selected.uuid] && statsForRemote[selected.uuid].count">&nbsp;/&nbsp;</small>
        <small data-ng-show="statsForRemote[selected.uuid].count"
               title="{{statsForRemote[selected.uuid].when | date:'M/d/yyyy HH:mm:ss'}}">
            <span>
              {{statsForRemote[selected.uuid].count}}
              <span data-translate="">recordsInRemote</span>
            </span>
        </small>
        <small data-ng-repeat="(key, value) in statsForScope[selected.uuid]"
               data-ng-if="key !== 'count' && key !== 'val'">
          <h6>{{key | translate}}</h6>
          <ul>
            <li data-ng-repeat="b in value.buckets">
              {{b.key_as_string}} ({{b.doc_count}})
            </li>
            <li data-ng-if="value.missing">
              {{'missing' | translate}} ({{value.missing.count}})
            </li>
          </ul>
        </small>

        <div class="alert alert-danger"
             data-ng-show="statsForRemote[selected.uuid].error"
             title="{{statsForRemote[selected.uuid].when | date:'M/d/yyyy HH:mm:ss'}}">
          <small>
            {{statsForRemote[selected.uuid].error}}
          </small>
        </div>
      </div>

      <div class="panel-body">
        <h2 data-translate="">harvesterCharacteristics</h2>
        <ul data-ng-show="!adding">
          <li data-ng-repeat="(key, value) in selected"
              data-ng-show="value && key !== 'name' && key !== 'tag'">
            <strong class="col-sm-4">{{key | translate}}</strong>
            <strong class="col-sm-8"
                    data-ng-if="value.indexOf === undefined || value.indexOf('http') === -1">
              {{value || ('undefined' | translate)}}
            </strong>
            <strong class="col-sm-8"
                    data-ng-if="value.indexOf('http') === 0">
              <a data-ng-href="{{value}}">{{value || ('undefined' | translate)}}</a>
            </strong>
          </li>
        </ul>
        <!-- Edit mode -->
        <div data-ng-show="adding">
          <div class="form-group"
               data-ng-repeat="(key, value) in selected"
               data-ng-if="key != 'tag'">
            <label for="field-{{key}}"
                   class="col-sm-4 control-label"
                   data-ng-class="{'required' : key === 'scope' || key === 'name' || key === 'url'}">
              {{key | translate}}</label>
            <div class="col-sm-8" data-ng-switch="key">
                  <textarea data-ng-switch-when="filter"
                            type="text" class="form-control"
                            id="field-{{key}}"
                            data-ng-model="selected[key]"
                            placeholder="{{(key + '-placeholder') | translate}}">
                  </textarea>

              <input data-ng-switch-default=""
                     type="text"
                     class="form-control"
                     id="field-{{key}}"
                     data-ng-disabled="key === 'uuid'"
                     data-ng-model="selected[key]"
                     placeholder="{{(key + '-placeholder') | translate}}">
              <p class="help-block">{{(key + '-help') | translate}}</p>
            </div>
          </div>
        </div>


        <br/>
        <div class="btn-group" data-ng-if="getUser().authenticated">
          <button role="button"
                  class="btn btn-default"
                  data-ng-show="!adding"
                  data-ng-click="edit(selected)"
                  title="{{'configure' | translate}}">
            <i class="fa fa-edit"></i>&nbsp;
            <span data-translate="">configure</span>
          </button>
          <button role="button"
                  class="btn btn-primary"
                  data-ng-show="adding"
                  data-ng-click="add(selected)"
                  title="{{'save' | translate}}">
            <i class="fa fa-save"></i>&nbsp;
            <span data-translate="">save</span>
          </button>
          <button class="btn btn-default"
                  data-ng-show="adding"
                  data-ng-click="cancelEdit()">
            <i class="fa fa-remove"/>&nbsp;
            <span data-translate="">cancel</span>
          </button>
          <button data-ng-click="run(selected)"
                  class="btn btn-default"
                  role="button"
                  title="{{'harvest' | translate}}">
            <i class="fa fa-play"></i>&nbsp;
            <span data-translate="">harvest</span>
          </button>
          <div class="btn-group" role="group">
            <button class="btn btn-default dropdown-toggle" type="button"
                    data-toggle="dropdown" aria-haspopup="true"
                    aria-expanded="true"
                    title="{{'actions' | translate}}">
              <i class="fa fa-cog"/>
              <span class="caret"></span>
            </button>
            <ul class="dropdown-menu">
              <li>
                <a role="button"
                   data-ng-click="getHitsNumber(selected)">
                  <i class="fa fa-calculator"></i>&nbsp;
                  <span data-translate="">getHitsNumber</span>
                </a>
              </li>
              <li role="separator" class="divider"></li>
              <li>
                <a role="button"
                   title="{{'viewRecords' | translate}}"
                   data-ng-show="statsForScope[selected.uuid].count > 0"
                   target="daobsDocuments"
                   data-ng-href="dashboard/app/kibana#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:now%2Fw,mode:quick,to:now%2Fw))&_a=(columns:!(scope,resourceTitle,inspireThemeNumberColor,isOpenData,isSchemaValid,isAboveThreshold,isValid,overviewUrl),index:records,interval:auto,query:(query_string:(analyze_wildcard:!t,query:'%2BharvesterUuid:{{h.uuid}}')),sort:!(_score,desc))&embed=true">
                  <i class="fa fa-eye"></i>&nbsp;
                  <span data-translate="">viewRecords</span>
                </a>
              </li>
              <li>
                <a role="button"
                   data-ng-click="removeRecords(selected)"
                   data-ng-show="statsForScope[selected.uuid].count > 0"
                   title="{{'removeRecords' | translate}}">
                  <i
                    class="fa fa-remove text-danger"></i>&nbsp;
                  <span data-translate="">removeRecords</span>
                </a>
              </li>
              <li>
                <a role="button"
                   data-ng-click="remove(selected)"
                   title="{{'remove' | translate}}">
                  <i class="fa fa-remove text-danger"></i>&nbsp;
                  <span data-translate="">removeHarvester</span>
                </a>
              </li>
              <li role="separator" class="divider"
                  data-ng-show="statsForScope[selected.uuid].count > 0"></li>
              <li>
                <a role="button"
                   data-ng-click="inspireValidation(selected)"
                   data-ng-show="statsForScope[selected.uuid].count > 0"
                   title="{{'restartInspireAll' | translate}}">
                  <i class="fa fa-fw"></i>&nbsp;
                  <span data-translate="">restartInspireAll</span>
                </a>
              </li>
              <li>
                <a role="button"
                   data-ng-click="inspireValidationNotValidated(selected)"
                   data-ng-show="statsForScope[selected.uuid].count > 0"
                   title="{{'notInspireValidated' | translate}}">
                  <i class="fa fa-fw"></i>&nbsp;
                  <span data-translate="">notInspireValidated</span>
                </a>
              </li>
              <li>
                <a role="button"
                   data-ng-click="eftValidation(selected, true)"
                   data-ng-show="statsForScope[selected.uuid].count > 0"
                   title="{{'restartEtfAll' | translate}}">
                  <i class="fa fa-fw"></i>&nbsp;
                  <span data-translate="">restartEtfAll</span>
                </a>
              </li>
              <li>
                <a role="button"
                   data-ng-click="eftValidation(selected, false)"
                   data-ng-show="statsForScope[selected.uuid].count > 0"
                   title="{{'restartEtfMissing' | translate}}">
                  <i class="fa fa-fw"></i>&nbsp;
                  <span data-translate="">restartEtfMissing</span>
                </a>
              </li>
              <li>
                <a role="button"
                   data-ng-click="serviceLinker(selected, false)"
                   data-ng-show="statsForScope[selected.uuid].count > 0"
                   title="{{'restartServiceLinker' | translate}}">
                  <i class="fa fa-fw"></i>&nbsp;
                  <span data-translate="">restartServiceLinker</span>
                </a>
              </li>
            </ul>
          </div>
        </div>

        <div class="btn-group" data-ng-if="!getUser().authenticated">
          <button class="btn btn-default dropdown-toggle" type="button" id="publicActions"
                  data-toggle="dropdown" aria-haspopup="true"
                  aria-expanded="true"
                  title="{{'actions' | translate}}">
            <i class="fa fa-cog"/>
            <span class="caret"></span>
          </button>
          <ul class="dropdown-menu">
            <li>
              <a role="button" id="publicGetHitsNumber"
                 data-ng-click="getHitsNumber(selected)">
                <i class="fa fa-calculator"></i>&nbsp;
                <span data-translate="">getHitsNumber</span>
              </a>
            </li>
          </ul>
        </div>



        <h2 data-translate="">harvesterHistory</h2>

        <div class="alert alert-warning"
             data-ng-hide="statsForScope[selected.uuid].aggregations.doc_count > 0"
             data-translate="">neverHarvested</div>

        <ul class="list-group">
          <li class="list-group-item"
              data-ng-repeat="d in statsForScope[selected.uuid].aggregations.harvestedDate.buckets">
            <!--<strong>{{d.key_as_string) | fromNow}}</strong> -->
            [{{d.key_as_string}}] -
            <strong>{{d.doc_count}} <span data-translate="">records</span></strong>
            <a class="btn btn-default"
               data-ng-click="loadDetails(selected.uuid, d.key_as_string)">
              <i class="fa fa-refresh"></i>&nbsp;
              <span data-translate="">harvesterLogDetails</a>

            <button class="btn btn-danger"
                    data-ng-click="removeRecords(selected, d.key_as_string)">
              <i class="fa fa-times"></i>&nbsp;
              <span data-translate="">
              removeHarvesterHistoryStep
            </button>

            <a role="button"
               title="{{'viewRecords' | translate}}"
               data-ng-show="statsForScope[selected.uuid].count > 0"
               target="daobsDocuments"
               data-ng-href="dashboard/app/kibana#/discover?_g=(refreshInterval:(display:Off,pause:!f,value:0),time:(from:now%2Fw,mode:quick,to:now%2Fw))&_a=(columns:!(scope,resourceTitle,inspireThemeNumberColor,isOpenData,isSchemaValid,isAboveThreshold,isValid,overviewUrl),index:AWEIpSwpXiWcyPgq_QlX,interval:auto,query:(query_string:(analyze_wildcard:!t,query:'%2BharvesterUuid:{{selected.uuid}}%20%2BharvestedDate:%22{{d.key_as_string}}%22%20%2BdocumentType:metadata')),sort:!(_score,desc))&embed=true">
              <i class="fa fa-eye"></i>&nbsp;
              <span data-translate="">viewRecords</span>
            </a>



            <p data-ng-show="logForScope[selected.uuid][d.key_as_string]">
            <ul>
              <li data-ng-repeat="report in logForScope[selected.uuid][d.key_as_string]">
                {{report._source.timestamp}} /
                {{report._source.reportMessage}}
              </li>
            </ul>

            </p>
          </li>
        </ul>

      </div>
    </div>

  </div>
</div>
